# DataFixter 工程开发待办事项

## 项目概述
DataFixter 是一个用于处理监测数据Excel文件的工具，主要功能是验证和修正监测数据中的累计变化量计算逻辑，确保数据的连续性和准确性。

## 核心需求分析

### 1. 数据源要求
- **输入目录1**: 需要处理的数据文件夹（包含所有监测期数据）
  - 路径: `E:\workspace\gmdi\tools\WorkPartner\excel\processed`
- **输入目录2**: 对比数据文件夹（用于验证和参考）
  - 路径: `E:\workspace\gmdi\tools\WorkPartner\excel`
- **文件格式**: 仅支持 .xls 格式（使用NPOI库读取）

### 2. Excel文件结构
- **数据起始行**: 第5行开始
- **数据结束行**: 第364行（共360行数据）
- **列结构**（从左至右）:
  1. 序号
  2. 点名（唯一标识）
  3. 里程
  4. 本期变化量（X）
  5. 本期变化量（Y）
  6. 本期变化量（Z）
  7. 累计变化量（X）
  8. 累计变化量（Y）
  9. 累计变化量（Z）
  10. 日变化量（X）
  11. 日变化量（Y）
  12. 日变化量（Z）

### 3. 文件命名规则
- 格式: `{日期}-{时}{项目名称}.xls`
- 示例: `2025.7.1-00云港城项目4#地块.xls`
- 文件按时间顺序排列，每期数据行数一致

### 4. 数据逻辑规则 ⭐ **核心业务逻辑**
- **基本公式**: 累计变化量 = 上一期累计变化量 + 本期变化量
- 适用于X、Y、Z三个方向的变化量
- **验证逻辑**: 逐一检查每个点名在每期数据中是否符合上述公式

### 5. 数据处理流程 ⭐ **关键流程**
1. **读取阶段**: 读取两个目录下的所有Excel文件
2. **分组阶段**: 按点名分组所有数据
3. **排序阶段**: 按时间排序每个点名的数据
4. **验证阶段**: 按点名逐期验证数据逻辑
5. **标记阶段**: 标记不符合逻辑的数据
6. **修正阶段**: 统一处理修正所有异常数据

### 6. 数据修正规则 ⭐ **修正策略**
- **优先级**: 优先调整本期变化量
- **本期变化量限制**: 调整后绝对值不能超过1
- **累计变化量限制**: 绝对值不能超过4
- **修正策略**: 从前往后逐期修正，注意前后期衔接
- **最小化原则**: 尽量减少修改的行数

### 7. 数据统计和报告要求
- **处理前统计**: 输出不合格数据占比（按点名统计）
- **处理后统计**: 输出每个点号调整数据的占比
- **统计维度**: 按点名、按文件、按调整类型分类统计
- **报告格式**: 仅在命令行输出，不生成其他格式文件

## 开发任务清单

### 阶段1: 项目基础搭建 ✅
- [x] 添加NPOI NuGet包依赖
- [x] 添加Serilog NuGet包依赖
- [x] 创建项目配置文件
- [x] 设置Serilog日志记录系统
- [x] 创建异常处理机制
- [x] 创建基础项目结构
- [x] 设置单元测试框架
- [x] 实现基础命令行界面（支持两个目录参数）
- [x] 实现基础Excel文件读取（支持.xls格式）

### 阶段2: 数据模型设计 ⭐ **核心架构**
- [x] 创建监测点数据模型类（MonitoringPoint）
  - 包含点名、里程等基础信息
  - 包含该点名的所有期数据列表
- [x] 创建单期数据模型类（PeriodData）
  - 包含文件信息、时间、所有列数据
  - 支持X、Y、Z三个方向的变化量
- [x] 创建文件信息模型类（FileInfo）
  - 解析文件名中的日期、时间、项目名称
  - 支持时间排序
- [x] 创建数据验证结果模型类（ValidationResult）
  - 记录验证失败的具体原因和位置
  - 支持按点名、按文件、按类型分类
- [x] 创建数据统计模型类（DataStatistics）
  - 支持按点名、按文件、按调整类型的统计
- [x] 创建调整记录模型类（AdjustmentRecord）
  - 记录每次数据调整的详细信息
  - 支持调整前后的数据对比

### 阶段3: Excel读取和解析 ⭐ **数据输入**
- [x] 实现Excel文件批量读取器
  - 支持读取指定目录下的所有.xls文件
  - 实现从第5行到第364行的数据提取
- [x] 实现文件名解析器
  - 解析日期、时间、项目名称
  - 支持时间排序功能
- [x] 实现数据标准化
  - 统一数据格式和类型
  - 处理空值和异常数据

### 阶段4: 数据分组和排序 ⭐ **数据处理核心**
- [x] 实现按点名分组功能
  - 将所有文件中的同名点数据合并
  - 建立点名到数据的映射关系
- [x] 实现按时间排序功能
  - 对每个点名的数据按时间顺序排列
  - 确保数据的时间连续性
- [x] 实现数据完整性检查
  - 验证每个点名在各期数据中的完整性
  - 标记缺失数据

### 阶段5: 数据验证逻辑 ⭐ **业务逻辑核心**
- [x] 实现累计变化量计算逻辑验证
  - 验证公式：累计变化量 = 上一期累计变化量 + 本期变化量
  - 支持X、Y、Z三个方向的验证
- [x] 实现与对比数据的交叉验证
  - 检查对比数据中对应点名是否为空
  - 标记需要修正的数据
- [x] 实现异常数据标记功能
  - 按点名、按文件、按类型分类标记
  - 生成详细的验证报告

### ✅ 阶段6: 数据修正算法 ⭐ **核心算法**
- [x] 实现本期变化量调整算法
  - 优先调整本期变化量
  - 确保调整后绝对值不超过1
- [x] 实现累计变化量调整算法
  - 当本期变化量调整后仍不满足要求时调整累计变化量
  - 确保调整后绝对值不超过4
- [x] 实现前后期衔接验证
  - 从前往后逐期修正
  - 确保修正后的数据连续性
- [x] 实现最小化修改策略
  - 尽量减少修改的行数
  - 优化修正算法

### ✅ 阶段7: 输出和报告 ⭐ **完整功能**
- [x] 实现修正后的Excel文件生成
  - 保持原始文件格式和结构
  - 生成修正后的新文件
- [x] 实现命令行报告输出功能
  - 处理前数据质量统计报告
  - 处理后调整数据统计报告
- [x] 实现按点名、按文件、按调整类型的分类统计
  - 不合格数据占比统计
  - 调整数据占比统计
- [x] 实现统计报告的命令行格式化输出
  - 清晰易读的表格格式
  - 详细的处理结果汇总
- [x] 实现完整的批量处理流程
  - 支持命令行参数：`DataFixter <待处理目录> <对比目录>`
  - 完整的6步处理流程：读取→标准化→分组→验证→修正→输出
  - 进度显示和详细统计报告

## 开发流程规范

### 1. 阶段开发原则
- **基础优先**: 每个阶段必须先搭建好基础框架
- **测试驱动**: 每个阶段必须通过测试后才能进入下一阶段
- **重构要求**: 进入下一阶段前必须重构当前代码并通过测试
- **任务更新**: 每完成一个任务必须更新待办事项

### 2. 开发阶段流程
1. **基础搭建**: 创建项目结构、添加依赖、设置测试框架
2. **功能实现**: 实现当前阶段的核心功能
3. **单元测试**: 编写并运行单元测试，确保功能正确
4. **代码重构**: 重构代码，提高代码质量和可维护性
5. **测试验证**: 重构后再次运行测试，确保功能正常
6. **任务更新**: 更新待办事项，标记已完成任务
7. **进入下一阶段**: 开始下一阶段的开发

## 技术实现要点

### 1. 核心算法设计 ⭐ **重点**
- **分组算法**: 高效的按点名分组算法
- **排序算法**: 按时间排序算法
- **验证算法**: 累计变化量逻辑验证算法
- **修正算法**: 最小化修正算法，确保前后期衔接

### 2. 数据验证策略
- 建立数据完整性检查
- 实现增量式验证（逐期验证）
- 处理缺失数据的情况
- 与对比数据的交叉验证

### 3. 修正算法设计
- 使用回溯算法确保修正的连续性
- 实现约束条件检查（绝对值限制）
- 优化算法性能，减少不必要的计算
- 最小化修改行数的策略

### 4. 错误处理
- 文件读取错误处理
- 数据格式错误处理
- 修正失败的回滚机制
- 验证失败的处理策略

### 5. 批量处理要求
- **命令行格式**: `DataFixter <待处理目录> <对比目录>`
- **批量处理**: 一次处理两个目录中的所有Excel文件
- **进度显示**: 显示当前处理的文件进度
- **汇总报告**: 处理完成后输出所有文件的汇总统计

## 测试策略

### 1. 测试数据要求
- **必须使用真实Excel文件进行测试**
- **待处理数据目录**: `E:\workspace\gmdi\tools\WorkPartner\excel\processed`
- **对比数据目录**: `E:\workspace\gmdi\tools\WorkPartner\excel`
- 所有功能测试必须基于上述目录中的实际Excel文件

### 2. 单元测试
- 项目基础框架测试
- 数据模型测试
- Excel读取功能测试
- 数据分组和排序测试
- 数据验证逻辑测试
- 修正算法测试
- 数据统计功能测试
- 报告生成功能测试

### 3. 集成测试
- 完整数据处理流程测试（使用指定Excel目录）
- 大文件处理性能测试
- 异常情况处理测试
- 真实Excel文件处理测试

### 4. 用户验收测试
- 真实Excel数据验证（使用指定目录）
- 修正结果准确性验证
- 性能指标验证
- 命令行输出质量验证

## 性能要求

### 1. 处理能力
- 支持单次处理100+个Excel文件
- 单文件处理时间不超过30秒
- 内存使用控制在合理范围内

### 2. 输出质量
- 修正后的数据逻辑一致性100%
- 修正幅度最小化
- 保持原始数据格式和结构
- 统计报告准确性100%
- 命令行报告输出清晰易读

## 风险评估

### 1. 技术风险
- NPOI库的兼容性问题
- 大文件处理的内存问题
- 修正算法的准确性风险
- 数据分组和排序的性能问题

### 2. 业务风险
- 数据修正可能影响历史数据连续性
- 修正规则可能不适用于所有情况
- 对比数据质量依赖风险
- 复杂数据关系的处理风险

## 后续优化方向

### 1. 功能扩展
- 支持.xlsx格式
- 支持更多数据验证规则
- 支持自定义修正策略
- 支持自定义统计维度
- 支持更多日志输出目标
- 支持日志配置热更新

### 2. 性能优化
- 并行处理多个文件
- 缓存机制优化
- 增量处理支持

### 3. 用户体验
- 命令行界面简洁易用
- 实时进度显示
- 详细的命令行处理报告
- 实时日志显示
- 日志级别动态调整
