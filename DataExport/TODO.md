# 数据导出工具开发待办事项

## 项目概述
基于现有的Excel导出curl命令，开发一个自动化数据导出工具，支持参数化配置和批量导出功能。

## 第一阶段：命令分析 ✅

### 已完成分析
- [x] 分析curl命令结构
- [x] 识别关键参数和头信息
- [x] 理解API端点结构

### 命令结构分析
**API端点**: `http://localhost:20472/QC_FoundationPit/ResultsQuery/ExportDataList`

**关键参数**:
- `projectId`: 项目ID
- `projectCode`: 项目编码
- `ProjectName`: 项目名称
- `DataCode`: 数据编码
- `DataName`: 数据名称
- `StartTime`: 开始时间
- `EndTime`: 结束时间
- `PointCodes`: (空)
- `WithDetail`: 1

**重要头信息**:
- Cookie: 包含认证信息
- Referer: 来源页面信息
- User-Agent: 浏览器标识

## 第二阶段：工具开发 ✅

### 核心功能开发
- [x] 创建配置类来管理导出参数
- [x] 实现HTTP客户端封装
- [x] 添加认证管理（Cookie处理）
- [x] 实现参数验证和默认值设置
- [x] 添加错误处理和重试机制
- [x] 修复文件格式验证问题
- [x] 实现智能文件格式检测
- [x] 添加自动文件重命名功能

### 参数化配置
- [x] 支持项目ID配置
- [x] 支持时间范围配置
- [x] 支持数据类型配置
- [x] 支持导出点配置
- [x] 支持批量项目导出

### 自动化功能
- [ ] 定时导出功能
- [x] 批量项目导出
- [ ] 导出结果通知
- [x] 日志记录和监控
- [x] 配置文件管理

## 第三阶段：新需求开发 🔥

### 多项目批量导出
- [x] 支持5个项目的批量导出
  - [x] 长金3号边坡 (28fd93ef-7b19-4886-98dd-dadc79deed03)
  - [x] 新造-石碁K25+800边坡 (28fd93ef-7b19-4886-98dd-dadc79deed09)
  - [x] 长金2号边坡 (8b503e5b-0de2-4051-a066-cd977b7cb18b)
  - [x] 新造-石碁K25+500边坡 (d90ace56-f56c-4222-8ce8-ea2173a2a1d3)
  - [x] 水长3号边坡 (d90ace56-f56c-4222-8ce8-ea2173a2a1s1)

### 多数据类型支持
- [x] 支持所有数据类型导出
  - [x] Angle-* (坡体表面倾斜相关)
  - [x] Rainfall-* (雨量监测)
  - [x] ThreeTran-* (坡体表面位移)
  - [x] Inclinometer-* (深度位移)

### 时间范围扩展
- [x] 支持2025年1月至7月的月度循环导出
  - [x] 2025-01-01 至 2025-01-31
  - [x] 2025-02-01 至 2025-02-28
  - [x] 2025-03-01 至 2025-03-31
  - [x] 2025-04-01 至 2025-04-30
  - [x] 2025-05-01 至 2025-05-31
  - [x] 2025-06-01 至 2025-06-30
  - [x] 2025-07-01 至 2025-07-31

### Excel合并功能
- [x] 按ProjectName和DataName合并Excel文件
- [x] 实现智能文件合并逻辑
- [x] 支持不同格式Excel文件的合并
- [x] 添加合并进度显示
- [x] 合并结果验证

## 第四阶段：扩展功能

### 数据管理
- [ ] 导出历史记录
- [ ] 数据质量检查
- [ ] 导出文件管理

### 用户界面
- [ ] 命令行界面
- [ ] 配置文件编辑器
- [ ] 导出进度显示
- [ ] 结果预览功能

### 集成和部署
- [ ] 单元测试
- [ ] 集成测试
- [ ] 部署脚本
- [ ] 文档编写

## 技术架构

### 核心组件
1. **配置管理器**: 处理参数配置和验证
2. **HTTP客户端**: 封装API调用
3. **认证管理器**: 处理Cookie和会话
4. **导出引擎**: 核心导出逻辑
5. **日志系统**: 记录操作和错误
6. **文件合并器**: Excel文件合并功能
7. **批量处理器**: 多项目多时间批量处理

### 依赖项
- .NET 8.0
- HttpClient
- JSON配置支持
- 日志框架
- Excel处理库 (EPPlus或ClosedXML)
- 单元测试框架

## 开发优先级

### 高优先级 (本周) 🔥
1. ✅ 多项目配置支持
2. ✅ 月度时间循环导出
3. ⏳ Excel文件合并功能

### 中优先级 (下周)
1. 批量导出优化
2. 错误处理和重试
3. 进度显示和日志

### 低优先级 (后续)
1. 用户界面开发
2. 高级配置选项
3. 性能优化

## 新需求详细说明

### 项目配置结构
```json
{
  "projects": [
    {
      "projectId": "28fd93ef-7b19-4886-98dd-dadc79deed03",
      "projectName": "长金3号边坡",
      "dataTypes": [
        {
          "dataCode": "Angle-PNYV",
          "dataName": "坡体表面倾斜"
        },
        {
          "dataCode": "Rainfall-ZIOZ", 
          "dataName": "雨量监测"
        },
        {
          "dataCode": "ThreeTran-DQQI",
          "dataName": "坡体表面位移"
        }
      ]
    }
  ]
}
```

### 导出流程
1. 读取项目配置
2. 循环每个项目
3. 循环每个数据类型
4. 循环每个月 (2025-01 到 2025-07)
5. 调用API导出数据
6. 保存Excel文件
7. 按ProjectName和DataName合并文件

### 文件命名规则
- 单个文件: `{ProjectName}_{DataName}_{StartTime}_{EndTime}.xlsx`
- 合并文件: `{ProjectName}_{DataName}_合并.xlsx`

## 注意事项

### 安全考虑
- Cookie信息不应硬编码
- 支持配置文件加密
- 添加访问权限控制

### 性能优化
- 支持并发导出
- 添加导出进度跟踪
- 优化内存使用
- 大文件合并优化

### 兼容性
- 支持不同.NET版本
- 跨平台兼容性
- 向后兼容性
- Excel格式兼容性

## 下一步行动

1. **立即开始**: 设计多项目配置结构
2. **本周完成**: 实现月度循环导出功能
3. **下周目标**: 开发Excel合并功能
4. **长期规划**: 完善批量导出和用户界面

---

*最后更新: 2024-12-19*
*负责人: 开发团队*
*新需求状态: 待开发*
